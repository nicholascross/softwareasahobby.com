<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"/><meta name="og:site_name" content="Software As A Hobby"/><link rel="canonical" href="https://www.softwareasahobby.com/posts/swift-aws-lambda"/><meta name="twitter:url" content="https://www.softwareasahobby.com/posts/swift-aws-lambda"/><meta name="og:url" content="https://www.softwareasahobby.com/posts/swift-aws-lambda"/><title>Swift AWS Lambda runtime | Software As A Hobby</title><meta name="twitter:title" content="Swift AWS Lambda runtime | Software As A Hobby"/><meta name="og:title" content="Swift AWS Lambda runtime | Software As A Hobby"/><meta name="description" content="Initial commit"/><meta name="twitter:description" content="Initial commit"/><meta name="og:description" content="Initial commit"/><meta name="twitter:card" content="summary"/><link rel="stylesheet" href="/styles.css" type="text/css"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><link rel="shortcut icon" href="/images/favicon.png" type="image/png"/><link rel="alternate" href="/feed.rss" type="application/rss+xml" title="Subscribe to Software As A Hobby"/></head><body class="item-page"><header><div class="wrapper"><a class="site-name" href="/">Software As A Hobby</a></div></header><div class="wrapper"><article><div class="content"><h1>Swift AWS Lambda runtime</h1><h2>Introduction</h2><p>The <a href="https://github.com/swift-server/swift-aws-lambda-runtime/">swift aws lambda runtime</a> project came up in my github activity as someone I follow starred the project.</p><p>The possibility to create lambdas in swift is intrigueing as we are using AWS Lambda to support the iOS app my team and I are building for my day job.</p><p>AWS doesn't support this runtime directly but they do support custom runtimes and this is a community driven project with support of the <a href="https://swift.org/blog/aws-lambda-runtime/">swift core team</a></p><p>I am not sure how easily interaction would be with other parts of the AWS ecosystem but I recently came across this project <a href="https://github.com/swift-aws/aws-sdk-swift">aws-sdk-swift</a> which perhaps might be of some help with future parts of this project.</p><p>As someone who was completely niave and with no previous AWS experience I thought it might be useful to document my experience of getting this up and running.</p><p><em>The following will likely not be an example of minimum approach and as I have no training on any part of AWS it will potentially also not be an example of best practices</em></p><h2>Create an AWS account</h2><p>This was all fairly straight forward and doesn't warrant documenting.</p><p>To get started go to <a href="https://aws.amazon.com">AWS website</a>.</p><p>From there sign up and get access to 12 months free tier. The thing I found slightly worrying was that as someone who wanted to just experiment with AWS not run a mission cirtical website there appears to be no way put a cap on expenditure. This seems to be an intentional oversight on the part of AWS with the justification being that a normal business would not want a hard cut off, but as an individual just learning AWS the thought of racking up a huge bill seems worrisome.</p><h2>Create a simple lambda</h2><p>For the purposes of testing I thought it would be helpful to have a simple lambda for testing.</p><img src="first_lambda.png" alt="First lambda for testing"/><p>From Services menu in AWS find "Lambda" and click create function. I chose Node.js as the Runtime for now but you can see options for "Custom Runtime" which I assume is what I will use later when I switch to swift.</p><img src="choose_runtime.png" alt="Choose runtime"/><p>A hello world style function should be created that will return a 200 response with a simple message anytime it is triggered.</p><h2>Configure API Gateway</h2><h3>Create a REST API</h3><p>From Services choose "API Gateway" and then click "Create API".</p><p>You can create different APIs I chose "REST API".</p><p>Once the API is created, I navigated to "Resources" where from the "Actions" dropdown I chose "Create Resource".</p><img src="create_resource.png" alt="Create resource"/><p>With the newly created Resource selected choose "Create Method". The integration type will obviously be "Lambda Function".</p><p>In the Lambda Function text field type the name of the Lambda, it should auto complete and click "Save".</p><h3>Create an API key</h3><p>I thought it wise to create an API key to somewhat restrict calls to the API.</p><p>This can be done under "API Keys", from "Actions" dropdown choose "Create API key", choose a name and allow AWS to auto generate a key.</p><h3>Create a Usage Plan</h3><p>To set limits on a specific API Key a usage plan must be created. From "Usage Plans" click "Create".</p><p>I chose a very low "Rate", "Burst" and "Quota" as I am more concerned with restricting accidental misuse or abuse rather than fullfilment.</p><h3>Create Stage for deployment</h3><p>Before you can create a stage you need deploy the lambda. From "Resource" select "Deploy API" from "Actions" dropdown.</p><p>From Stages chose "Create" and specify a name for the stage and choose the deployment from the dropdown.</p><h3>Assocate API Key</h3><p>From "Usage Plans" select the plan created previously and then click "Add API Stage".</p><p>Choose the API and stage.</p><p>Additionally the Resource Method must specify "API Key Request" as <code>true</code>. I am not sure if this is the best way but I did this from Resources, by selecting the Method.</p><img src="require_api_key.png" alt="Require API Key"/><h2>Setting up a custom domain</h2><p>I decided to use a subdomain for a domain I already own. With very limited knowledge of name server configuration this proved slightly challenging but here is the steps I followed.</p><h3>Create an SSL certificate</h3><p>All traffic must be encrypted using HTTPS a certificate needs to be created or provided. I chose to create a new one for my specific sub domain using AWS Certificate Manager.</p><p>To get the certificate issued you have to validate that you are the owner of the domain as I do not have admin or webmaster email addresses set up for the domain in question I had to use DNS record approach for this.</p><p>To do this I had to specify a new CNAME record, it is important to note that the CNAME record was not just for the particular subdomain but there was an additional "random" string of characters to be specified as well. This can be found under the name column.</p><h3>Create a custom domain</h3><p>Back under API Gateway service select "Custom domain names" and click "Create".</p><p>I specified my subdomain and as I intend to only use this from a single region I chose "Regional" end point type.</p><p>Choose the certificate created previously in AWS Certificate Manager and click "Create".</p><p>Next click "Configure API Mappings" and add a new mapping for the API and Stage.</p><h3>Delegate subdomain authority</h3><p>As my domain is hosted outside of AWS I had to delegate authority for the subdomain to AWS Route53 service.</p><ol><li>Create new hosted zone in Route53.</li><li>Create new NS records in the register of my domain outside of AWS. Each NS record is for the subdomain and should have the value of the name servers specified in Route53 for the domain.</li><li>The SOA record in Route53 indicates that responsibility for this sub domain will be managed from there.</li><li>In Route53 add a new record set for the subdomain of type <code>A</code></li><li>Choose "Alias" <code>Yes</code> radio option</li><li>Specify the alias target to be the API gateway</li></ol><h2>Using Swift Lambda runtime</h2><h3>Prerequisites</h3><ol><li>Install <a href="https://www.docker.com/products/docker-desktop">Docker</a></li><li>Install <a href="https://stedolan.github.io/jq/download/">jq</a></li><li>Install <a href="https://docs.aws.amazon.com/cli/latest/userguide/install-cliv2-mac.html">aws cli</a></li><li><a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/getting-started_create-admin-group.html">Create IAM Admin user</a></li><li><a href="https://docs.aws.amazon.com/cli/latest/userguide/cli-chap-configure.html">Configure aws cli</a></li></ol><h3>Deploying hello world swift lambda</h3><ol><li>Create a new s3 bucket <code>swift-lambda-test</code> which is used during the deployment process</li><li>Create a new lambda named <code>HelloSwift</code> with a custom runtime</li><li>Expose the the lambda through the API Gateway Service</li><li>Enforce API Key restrictions</li><li>Next clone <code>git@github.com:swift-server/swift-aws-lambda-runtime.git</code></li><li>Modify <code>deploy.sh</code> in the examples <code>scripts</code><ul><li>change <code>lambda_name</code> value to <code>HelloSwift</code>.</li></ul></li></ol><ol start="7"><li>run <code>./scripts/deploy.sh</code></li><li>Deploy the newly updated API to your Stage in API Gateway</li></ol><p>Done. ðŸš€</p></div><span>Tagged with: </span><ul class="tag-list"><li><a href="/tags/experiment">experiment</a></li><li><a href="/tags/aws">aws</a></li><li><a href="/tags/lambda">lambda</a></li><li><a href="/tags/api-gateway">api gateway</a></li><li><a href="/tags/route53">route53</a></li><li><a href="/tags/custom-domain">custom domain</a></li><li><a href="/tags/swift">swift</a></li><li><a href="/tags/dns-configuration">dns configuration</a></li><li><a href="/tags/server-side-swift">server side swift</a></li></ul></article></div><footer><p>Generated using <a href="https://github.com/johnsundell/publish">Publish</a></p><p><a href="/feed.rss">RSS feed</a></p></footer></body></html>